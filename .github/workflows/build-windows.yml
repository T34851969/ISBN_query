# GitHub Actions: Build Windows .exe using PyInstaller
# - Builds on windows-latest using specified Python version
# - Caches pip dependencies
# - Supports optional GUI (native window) and web server mode controlled by NICEGUI_NATIVE
# - Uploads build artifact and creates a GitHub Release when triggered by a tag

name: Build Windows exe (PyInstaller)

on:
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to use (ex: 3.11)'
        required: false
        default: '3.11'
      build-type:
        description: 'Build type: web or native'
        required: false
        default: 'web'
  push:
    branches: [ main ]
    tags: ['v*.*.*']
  pull_request:

concurrency:
  group: build-windows-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: ISBNQuery
  OUTPUT_DIR: out
  DIST_ZIP_NAME: ISBNQuery-windows-x64.zip

jobs:
  build:
    name: Build Windows executable
    runs-on: windows-latest
    env:
      PYTHON_VERSION: ${{ github.event.inputs.python-version || '3.11' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\pip\Cache
            .\.venv
          key: pip-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-${{ env.PYTHON_VERSION }}-

      - name: Create venv and upgrade pip
        run: |
          python -m venv .venv
          .\.venv\Scripts\python -m pip install --upgrade pip setuptools wheel

      - name: Install dependencies
        shell: pwsh
        run: |
          $pip = "./.venv/Scripts/pip.exe"
          if (Test-Path requirements.txt) {
            & $pip install -r requirements.txt
          } else {
            & $pip install pandas nicegui fastapi pyinstaller openpyxl pandas-calamine uvicorn
          }

      - name: Sanity pip check
        run: |
          .\.venv\Scripts\python -m pip check || true

      - name: Build with PyInstaller
        env:
          NICEGUI_NATIVE: ${{ github.event.inputs.build-type == 'native' && '1' || '0' }}
          APP_NAME: ${{ env.APP_NAME }}
          PYTHON_VERSION: ${{ env.PYTHON_VERSION }}
        shell: pwsh
        run: |
          $env:PY = ".\.venv\Scripts\python"
          $env:PIP = ".\.venv\Scripts\pip"

          # Clean build dirs
          if (Test-Path build) { Remove-Item build -Recurse -Force }
          if (Test-Path dist) { Remove-Item dist -Recurse -Force }
          if (Test-Path __pycache__) { Remove-Item __pycache__ -Recurse -Force }

          # Base flags
          $pyinstallerFlags = '--noconfirm --clean --onefile -n ' + $env:APP_NAME

          # Native (windowed) mode
          if ($env:NICEGUI_NATIVE -eq '1') { $pyinstallerFlags += ' --windowed' }

          Write-Host "Running PyInstaller with flags: $pyinstallerFlags"
          & $env:PY -m PyInstaller $pyinstallerFlags isbn_query.spec

      - name: Package artifact and compute checksum
        run: |
          mkdir %OUTPUT_DIR%
          powershell -Command "Compress-Archive -Path dist\%APP_NAME%.exe -DestinationPath %OUTPUT_DIR%\${{ env.DIST_ZIP_NAME }} -Force"
          powershell -Command "Get-FileHash %OUTPUT_DIR%\${{ env.DIST_ZIP_NAME }} -Algorithm SHA256 | Out-File -FilePath %OUTPUT_DIR%\${{ env.DIST_ZIP_NAME }}.sha256 -Encoding utf8"

      - name: Show artifact listing
        run: dir %OUTPUT_DIR% && dir dist

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-x64
          path: ${{ env.OUTPUT_DIR }}

      - name: Create release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          artifacts: ${{ env.OUTPUT_DIR }}/
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Automated build of ${{ env.APP_NAME }} for Windows.
            Built with Python ${{ env.PYTHON_VERSION }} on ${{ runner.os }}.

      - name: Upload exe to release (if applicable)
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "Release created and artifacts uploaded by ncipollo/release-action."

      - name: Archive build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build

      - name: Post-build info
        run: |
          echo "Build finished. Artifacts available: ${{ env.OUTPUT_DIR }}/${{ env.DIST_ZIP_NAME }}"


# Notes:
# - This workflow builds a Windows exe using PyInstaller with a virtualenv to keep dependencies isolated.
# - For GUI/native builds that use PyQt/PySide or pywebview, consider adding those packages to requirements and adding additional --hidden-import or --collect-binaries entries into a spec file.
# - If your app requires additional custom binaries or data files, add them via --add-data or a custom .spec.
# - For production signing, add a code signing step using a secrets-backed certificate and signtool in a secure manner.
